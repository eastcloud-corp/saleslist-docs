# B-001 / B-002 / B-003 修正方針

## 概要
- **B-001**（レビュー否認後 404）: `CompanyReviewViewSet` のデフォルトフィルタが `STATUS_PENDING` / `STATUS_IN_REVIEW` のみを対象にしているため、否認実行直後に `status=rejected` へ遷移したバッチへのアクセスが `Http404` になり、フロント側で 404 画面が表示される。
- **B-002**（本番でサンプル生成ボタン表示）: 開発用サンプル生成 UI/エンドポイントに環境ガードがなく、本番利用者にも表示・実行できてしまう。
- **B-003**（AI/バッチ処理件数・対象企業が不明）: `DataCollectionRun.metadata` に処理件数だけが記録され、対象企業 ID や UI 上のリンクが無いため、運用時に追跡しづらい。

以下、各課題の対応方針と実装詳細をまとめる。

---

## B-001: レビューで否認を選択すると 404 画面になる

### 現象
- レビュー詳細ダイアログから「否認」を含む決定を反映すると、API `/api/v1/companies/reviews/{id}/decide/` 実行後に再取得されたレビュー詳細が `404` となり、Next.js の 404 画面に遷移してしまう。
- バックエンドログにも `Http404: Not Found` が記録されている。

### 原因仮説
- `CompanyReviewViewSet.get_queryset()` はクエリパラメータ `status` が無い場合、`pending` / `in_review` のみをフィルタリングする。
- `decide` アクション内で `self.get_object()` を呼び出す際、既に別ユーザーが否認済みだったり、連続操作で `status=rejected/approved/partial` へ遷移したバッチを参照すると、クエリから除外されて `Http404` が発生する。
- `retrieve` アクションでも同様のフィルタが適用されるため、否認済みバッチを開こうとすると 404。

### 対応方針
1. `get_queryset()` で `self.action` を参照し、`list` 以外（`retrieve` / `decide` 等）のアクションではステータスフィルタを緩和して全ステータスを対象とする。
2. `decide` 実行時にバッチの現在ステータスが `pending` / `in_review` 以外の場合は 409 を返し、前提崩れを明示する。
3. フロントのレビュー画面は API エラーをトースト表示にとどめる（現状でも `ApiError` をキャッチしているため 404 ページ遷移はガードされる想定だが、再発防止のためエラーハンドリングを再確認）。

### 実装詳細
- `saleslist-backend/companies/views.py`
  - `get_queryset` に `if self.action in {'retrieve', 'decide'}` の条件を追加し、デフォルトフィルタをスキップする。
  - `decide` 内で `batch.status` をチェックし、`pending/in_review` 以外なら `return Response({...}, status=HTTP_409_CONFLICT)`.
- `saleslist-front/hooks/use-company-reviews.tsx`
  - `decide` / `fetchBatch` の `catch` で 404 を受けた場合は「対象レビューが見つかりません」トーストとダイアログ閉じ処理を実行する（キャッシュされたバッチが消えたケースへの備え）。

### テスト観点
- `companies/tests.py` に 404 → 409 へ仕様変更したユニットテストを追加。
- 否認後でも `/companies/reviews/{id}/` GET が 200 になることを確認する API テストを追加。
- フロントは `useCompanyReviewBatch` の単体テスト or Storybook でモック 404 を確認。

### リスク / フォローアップ
- 既存クエリ負荷: 全ステータス取得を許容しても件数は限定的だが、必要に応じて `prefetch` を維持。
- 409 を返した際の UX: フロントのトースト文言を明確にする。

---

## B-002: 本番環境でレビュー用サンプルデータ追加ボタンが表示される

### 現象
- レビュー画面右上にある「サンプル候補生成」ボタンが本番環境にも表示され、実際に API を叩けてしまう。
- バックエンド側にも環境ガードが無く、誤操作で擬似データが混入する恐れがある。

### 対応方針
1. **フロント**: `NEXT_PUBLIC_ENVIRONMENT` を参照し、本番 (`production` / `prd`) ではボタンを非表示にする。必要に応じて `NEXT_PUBLIC_ENABLE_REVIEW_SAMPLE` フラグで強制表示を許可。
2. **バックエンド**: `generate_sample` アクションに `if not settings.DEBUG and not getattr(settings, "ENABLE_REVIEW_SAMPLE_API", False)` のガードを追加し、403 を返す。

### 実装詳細
- フロント (`app/companies/reviews/page.tsx`)
  - 既存の `isTestEnvironment` 判定に `const canGenerateSample = isTestEnvironment || process.env.NEXT_PUBLIC_ENABLE_REVIEW_SAMPLE === "true"` を追加し、ボタンの描画条件を `canGenerateSample` に置換。
  - トースト文言は従来通り（開発専用のまま）。
- バックエンド (`companies/views.py`)
  - `generate_sample` 冒頭でガードを行い、403 レスポンスの JSON メッセージ（例: `"この操作は開発環境専用です"`）を返却。
  - 新しい設定キー `ENABLE_REVIEW_SAMPLE_API`（デフォルト False）を `config/settings/base.py` へ追加。
- インフラ側: 開発用 `.env` はこれまで通り、Production には設定不要。

### テスト観点
- Django 側で 403 が返ることを `companies/tests.py` へ追加。
- フロントの E2E（Playwright）で `NEXT_PUBLIC_ENVIRONMENT=production` 時にボタン非表示となることを確認。

### リスク / フォローアップ
- 運用で本番でも生成したい場合は環境変数追加で対応可能。
- 既存の `generate_sample` を呼び出す自動テストがあれば、環境変数をセットするよう修正。

---

## B-003: AI/クロンク系の処理件数・対象企業 ID が分からない

### 現象
- `DataCollectionRun` に処理件数は格納されるが、対象企業 ID が記録されず UI からトレースできない。
- 運用担当が「どの企業が処理対象だったか」「詳細ページをすぐ開きたい」といったニーズに対応できない。

### 対応方針
1. バックエンドの各タスク（AI 補完、法人番号連携、オープンデータ取り込みなど）で、処理対象の企業 ID リストを `metadata.processed_company_ids`（最大 100 件）として記録し、件数を `metadata.processed_count` に明示する。
2. 長大なリストは `metadata.processed_company_ids_truncated=true` で表現し、フロント側で「100件超過」を表示。
3. Data Collection History UI で `metadata.processed_company_ids` を参照し、企業詳細へのリンク付きバッジを表示する。

### 実装詳細
- バックエンド
  - `ai_enrichment/tasks.py` / `companies/tasks.py`（法人番号、オープンデータ関連）で、処理対象 ID を `processed_ids = [company.id ...]` として集約。
  - `run_tracker.complete_success(...)` の `metadata` に以下を追加:
    ```python
    sample_ids = processed_ids[:100]
    metadata = {
        **existing_metadata,
        "processed_count": len(processed_ids),
        "processed_company_ids": sample_ids,
        "processed_company_ids_truncated": len(processed_ids) > len(sample_ids),
    }
    ```
  - 入力が空だったケースも `processed_count=0` を明示。
- フロント
  - `lib/types.ts` の `DataCollectionRun.metadata` 型に上記キーを追加（`processed_company_ids?: number[]` など）。
  - `app/data-collection/history/page.tsx` で「処理件数」列を新設、ID がある場合は `Link href={`/companies/${id}`}` でバッジ表示。
  - 会社詳細ページが Next.js 上に存在しない場合は `/companies?company_id=xxx` の検索パラメータ導入を検討（暫定で API ベース URL へのリンクも検討）。

### テスト観点
- `ai_enrichment/tests` / `companies/tests` で `metadata` に ID リストが残ることを検証。
- Data Collection API のシリアライザが新メタキーを返すことを確認するユニットテスト。
- フロントで `processed_company_ids` が無いケース（旧レコード）でも表示が崩れないことを Storybook or Jest で確認。

### リスク / フォローアップ
- 長期的には `processed_company_ids` が肥大化する可能性があるため、必要に応じて別テーブル化を検討。まずは 100 件のスナップショットで様子を見る。
- 既存メタデータとの互換性: JSONField なので後方互換性は確保される。

---

## 次のアクション
- 上記設計に基づき、バックエンド（`companies` / `ai_enrichment` / `data_collection`）とフロント (`app/companies/reviews`, `app/data-collection/history`) の修正ブランチを作成。
- 修正後は本番での挙動確認リストに「否認→ページ遷移」「サンプルボタン非表示」「AI 実行後の履歴リンク表示」を追加。*** End Patch ***

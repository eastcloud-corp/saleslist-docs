# SalesList 管理者ガイド

> **対象**: システム管理者・運用リーダー
> **目的**: データ収集バッチ、レビュー監査、NG 統制など管理者が担う運用手順を整理しています。

## 1. データ収集ジョブと運用条件

| 収集元 | 主な収集対象 | 自動実行タイミング・条件 | 備考 |
| --- | --- | --- | --- |
| 国税庁法人番号 Web-API | 商号・所在地・法人番号・設立日 | 毎晩自動実行。直近30日以内に取得済みの企業はスキップ。1日あたり約4,000件まで。`CORPORATE_NUMBER_API_TOKEN` が必須。 | 手動実行ボタンは開発用。実運用では深夜バッチに任せる。 |
| 自治体オープンデータ（東京都・静岡県・大阪府） | 住所・電話・資本金・業種など | 毎晩自動実行。ソースキー未指定時は YAML に定義した全ソースを順番に処理。 | 必要に応じて管理者が `source_keys` を指定して個別再取得できる。 |
| Facebook Page メトリクス | フォロワー数・最新投稿日時 | 将来的に稼働予定。`FACEBOOK_ACCESS_TOKEN` 未設定時はスキップし、履歴にもその旨が記録される。 | 本番導入まで「準備中」と案内する。 |
| AI 補完（PowerPlexy） | 担当者名・所在地・事業内容などの欠損項目 | 手動トリガーまたは必要に応じて Celery Beat（`ai.enrich`）。1 回あたり最大 500 件、月間 5,000 件 / 約 20 USD が既定上限。 | `POWERPLEXY_*` 環境変数で API キーと上限を管理。 |

- **source_keys とは?** `config/opendata_sources.yaml` に記載されたソース名（例: `tokyo_corporate_members` など）。手動トリガー時に入力するとそのソースのみ再取得します。空の場合は全ソース対象。
- いずれのジョブも結果は「会社情報自動取得レビュー」に流れ、承認された値だけ企業マスタへ反映されます。

## 2. データ収集履歴ページの使い方

1. **アクセス**: サイドバー「データ収集履歴」（管理者のみ表示）。次回実行予定や手動トリガーがまとめられています。
2. **フィルタリング**: ジョブ／ステータス／期間で履歴を絞り込み。対象行をクリックするとエラー概要・スキップ内訳・メタデータを確認できます。
3. **手動トリガー**: バッチの再実行や個別検証が必要なときに使用。オープンデータは `source_keys`、AI 補完は `company_ids` を指定すると対象を限定できます。
4. **利用状況の確認**: AI 補完を選択すると、画面内に「今月の実行回数／コスト残高」が表示されます。上限に近付いた場合は実行を控えてください。
5. **ログ参照**: 失敗（`FAILURE`）行で `metadata.result` に詳細ログが残るので、Celery ログと突合すると原因追跡が早いです。
6. **権限制御**: 一般ユーザーからはメニューごと非表示。管理者が必要なときのみ利用してください。

## 3. レビュー監査・NG 統制

### 3.1 レビュー監査
- 承認／否認の履歴は企業詳細の「履歴」タブと `company_update_history` に記録されます。月次で CSV 抽出する場合は管理者用バッチで取得してください。
- 気になる企業があればデータ収集履歴で該当バッチを辿り、メタデータの候補値から収集元を特定できます。
- AI 補完の候補は信頼度（confidence）が 85（AI由来）または 100（ルール由来）で入るため、承認前に候補値と差分を必ず確認してください。

### 3.2 NG リスト統制
- NG CSV は定期的にレビューし、法人番号メンテと合わせて更新。NG の理由や解除履歴は操作メモに残す運用がおすすめです。
- NG 状態の企業が案件に紛れ込んだ場合は、企業管理から NG を解除して再度候補を選び直すようオペレーターに案内します。

## 4. よくある質問（管理者向け）

**Q. バッチが失敗したが原因ログはどこで確認できるか？**  
A. 「データ収集履歴」で該当行を展開し、`metadata.result` または警告メッセージを確認してください。Celery ログと突き合わせると詳細が分かります。

**Q. レビュー画面の手動ボタンを本番で使わせたくない。**  
A. 本番環境ではテンプレートから該当ボタンを非表示にするか feature flag で制御します。暫定的には権限で UI を隠す運用形態を取っています。

**Q. AI 補完で月次上限に達したらどうなるか？**  
A. `UsageTracker` がスキップ処理を返し、Slack/メールに通知が飛ぶ設定です。翌月に自動でリセットされるので、それまでは手動実行を控えてください。

---

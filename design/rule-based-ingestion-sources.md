# ルールベースデータソース仕様

## 1. 背景
- AI 連携の前段として、確定値や公的データに基づくルールベース収集を優先実装する。
- 各ソースのフォーマット／更新頻度／認証要件を整理し、収集ハンドラ（collector）開発のバックログを作成する。

## 2. 想定する共通インターフェース
- 収集ハンドラごとに `collect()` を実装し、正規化済みレコードを返す。
- レコードは `{"company_identifier": <法人番号 or 名称>, "field": "corporate_number", "value": "123456789012", "source": "nta_corporate_api", "metadata": {...}}` の形で `ingest_rule_based_candidates` に渡す。
- Celery Beat から定期実行、もしくはオンデマンド実行を想定。

## 3. データソース一覧

| 優先度 | ソース名 | 主対象フィールド | フォーマット | 取得方法 / 更新頻度 | 認証 | 備考・課題 |
| --- | --- | --- | --- | --- | --- | --- |
| 高（採用） | 国税庁 法人番号API（拡張） | 住所、資本金（資本金等情報）、商号 | JSON（APIレスポンス） | API、日次または週次 | APIキー要 | `source_detail=nta_corporate_api`。レート制限（1日5,000件／2秒間隔）とクールダウンを遵守。 |
| 高（採用） | 東京都オープンデータ「法人会員企業一覧」 | 法人番号、所在地、資本金、業種、公式URL | CSV (ZIP) | Webダウンロード、月次想定 | 不要 | `https://catalog.data.metro.tokyo.lg.jp/dataset/t000010d0000000055`。URL は `config/opendata_sources.yaml` に登録。 |
| 高（採用） | 静岡県オープンデータ「企業情報データベース」 | 法人番号、所在地、従業員数、URL、電話 | CSV | Webダウンロード、随時更新 | 不要 | 公式 CSV から取得。電話はハイフン除去で正規化し、`source_detail=local_gov_open_data_shizuoka`。 |
| 高（採用） | 大阪府オープンデータ「中小企業サポート企業情報」 | 法人番号、所在地、資本金、従業員数、業種コード、URL | CSV | Webダウンロード、随時更新 | 不要 | 業種コード付き。`source_detail=local_gov_open_data_osaka` として記録。 |
| 中 | gBizINFO 企業・支援データ | 業種（中分類）、認定情報、資本金、従業員規模 | CSV / JSON | API or ダウンロード、月次 | APIキー発行 | 将来拡張候補。採用時は API キーとレート制御を追加管理。 |
| 中 | 官報 公告情報（設立・解散） | 設立日、解散日、商号変更 | XML/RSS/HTML | RSS取得＋スクレイピング、日次 | 不要 | 企業名ベースマッチング。法人番号不明の場合は fuzzy matching で候補提示。 |
| 中 | 認証事業者リスト（例：IT導入補助金支援事業者、J-Startup） | 認定ラベル、業種分野 | Excel/CSV | Webダウンロード、四半期 | 不要 | 企業名ベース。法人番号が無いケースあり。重複マッチングロジックの共通化が必要。 |
| 低 | 官庁調達・入札情報（e-Gov調達データ） | 最新活動、入札実績 | CSV | Webダウンロード、日次〜週次 | 不要 | 直接的な基本属性では無いが「活動タイムライン」向けの将来候補。 |
| 低 | 登記情報ダウンロードサービス（有償） | 役員、資本金、所在地 | CSV/固定長 | API/HTTP、随時 | 契約＋課金 | 今回は要検討。コスト見合いで後回し。 |

## 4. 収集ハンドラ開発バックログ
1. **NTA拡張ハンドラ**（既存法人番号クライアントを再利用）
   - TODO: 住所／資本金取得のレスポンス解析、`metadata` 保存。
   - ソースID: `nta_corporate_api`.
2. **gBizINFO ハンドラ**
   - TODO: APIクライアント実装、レート制御、CSV fallback。
   - ソースID: `gbizinfo`.
3. **自治体オープンデータ汎用ハンドラ**
   - TODO: CSVマッピング設定 (`config/opendata_sources.yaml`) を作成し、東京都・静岡県・大阪府の URL／列マッピングを管理。
   - ソースID: `local_gov_open_data_<pref>` を予定。
4. **官報公告ハンドラ**
   - TODO: RSS/HTML パーサ、名称正規化＋スコアリング。
   - ソースID: `kanpo_official_bulletin`.
5. **認証事業者リストハンドラ**
   - TODO: Excel/CSV の共通パーサ、法人番号推定ロジック。
   - ソースID: `certified_vendor_lists`.
6. **（将来）調達／入札情報ハンドラ**
   - TODO: 活動ログ向けフィールドの定義検討。
   - ソースID: `procurement_feeds`.

## 5. 非機能要件メモ
- 実行時間: 1ソースあたり 5〜10 分以内を目標（大量CSVは夜間実行）。
- エラーハンドリング: 失敗時は Slack 通知（要追加）＋再実行用のリトライキューを検討。
- ログ: 収集件数、スキップ件数、エラー件数を構造化ログで出力。
- バッチ管理: `external_source_records`（新テーブル）に取得日時／ファイルハッシュを保持し、差分検知と重複防止に活用。
- 公式サイト URL は候補として `candidate_value` に正規化した URL を保存し、`metadata.original_url` に生データを保持する。
- **再取得制御**:
  - ソースごとに最終取得日時とレスポンスハッシュを保存し、7日以内に同一企業を再取得しようとした場合は原則スキップ。
  - `ingest_rule_based_candidates` 呼び出し前に `cooldown_days` をチェックし、直近更新済みレコードは候補生成を行わない。
  - 差分が検知された場合（ハッシュ不一致）はクールダウン中でも再取得を許可。
  - 強制再取得オプション（例: `force=True` や `company_ids` 指定）で個別再取得を可能にする。
- **法人番号APIレート制御**:
  - デフォルトで「1日最大 5,000 回」「連続呼び出しは 2 秒以上の間隔」を厳守する。超過しそうな場合は途中で処理を打ち切り、統計値とメッセージを返す。
  - 企業単位では `corporate_number` 取得履歴を見て 30 日以内は API 呼び出し自体をスキップし、候補投入時も同じクールダウンを適用。
  - 開発確認用には `force=True` を指定するとクールダウンとレート制限を無効化し、即時の再取得が可能。
  - 実際に API 接続を伴う確認を行う場合は、国税庁法人番号 Web-API の利用者ID（トークン）を取得して `.env` の `CORPORATE_NUMBER_API_TOKEN` に設定し、夜間・低頻度の実行を徹底する。
  - ローカルで API を使わず挙動のみを確認したいケースでは、今後追加予定のモック／スタブ API を利用するか、既存のサンプル生成エンドポイントでダミーデータを投入して動作確認する。

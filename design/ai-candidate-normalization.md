# AI補完候補値の正規化方針

## 背景
- PowerPlexy から返ってくる値は人間向けのフォーマットになっており、レビュー承認 API では数値フィールドに数値以外の文字（「2024年」「6,500,000円」「650万円」など）が送られると 400 Bad Request になる。
- レビュアーが毎回手作業で値を修正すると AI 補完のメリットが薄れるため、候補登録前に自動で整形したい。

## 対象フィールドと課題
| フィールド | 課題パターン例 | 正規化方針 |
| --- | --- | --- |
| `established_year` | `2024年`, `2024/03/22`, `平成36年(2024年)` | 西暦4桁を抽出。和暦（令和/平成）は対応表で西暦へ変換。数字が8桁の場合は先頭4桁を採用。その他フォーマットは数字のみ抽出し 4 桁化。 |
| `capital` | `6,500,000円`, `650万円`, `0.65億円`, `約650万` | 記号（円, , , 空白）を除去。`億`=10^8、`万`=10^4 として乗算し総額（円）へ変換。概算表現（約, およそ等）は除去して数値化。変換不可能な場合は候補を破棄する。 |
| `contact_person_name` | `代表取締役 菊地航輔`, `菊地航輔（代表取締役）` | 役職フレーズや括弧内の補足を除去し氏名のみを残す。 |
| `contact_person_position` | `代表取締役／CEO`, `代表取締役 菊地航輔` | スラッシュ区切りは先頭要素を採用。氏名が混在する場合は氏名部分を除去。 |
| その他数値系 | `約50名`, `50人以上` | 数字のみ抽出し概算を丸める（例: 50人以上→50）。必要に応じて閾値超過は候補破棄。 |

## 実装方針
1. `ai_enrichment/normalizers.py` にフィールド単位の正規化関数を実装（単体テスト付き）。
2. `run_ai_enrich` が候補エントリを組み立てる際に `normalize_candidate_value(field, value)` を呼び、正規化済みの値で `ingest_rule_based_candidates` に渡す。
3. 正規化後に空になる場合は候補をスキップし、ログにフィールド名と元値を debug レベルで出力する。
4. 将来的にルールベースのソース（オープンデータ等）からの候補にも再利用できるよう、関数は汎用的に設計する。

## テスト
- 正規化関数の単体テスト（年/資本金/担当者）を追加。
- `ai.enrich` タスクの integration テストは既存のものを流用し、正規化済みの値が保存されることを確認する。

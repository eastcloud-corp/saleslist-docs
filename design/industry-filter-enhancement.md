# 業界フィルター改善設計メモ

## 目的
- CSV 取込済みの企業データでは「マーケティング・IT、不動産」のような複合表記が多く、現在の業界フィルター（完全一致 & マスタ 11 件）とマッチしない。
- フィルター UI を検索入力付きコンボボックスに刷新し、複数業界表記にもマッチするようバックエンドを部分一致に変更する。
- ユーザーが任意の業界語を入力できるようにしつつ、よく使われる候補を提示することで操作性を維持する。

## 現状整理
- フロント
  - `saleslist-front/components/companies/company-filters.tsx` で `Select` を利用しており、入力欄はなし。
  - 候補は `/masters/industries` API (11 件) もしくは会社一覧の `industry` を重複排除して使用。
- バックエンド
  - `saleslist-backend/companies/views.py:95` で `industry__in` を用いた完全一致フィルター。
  - CSV インポートでは最大 100 文字の文字列をそのまま保存している。
- データ
  - `budget_list_clean_fixed.csv` を区切り記号（、・／/,）で分割すると、ユニークな業界語は 1,586 種類。
  - 上位語（出現回数の多い順）は以下の通り（抜粋）。

| 順位 | 業界語 | 出現数 |
|------|--------|--------|
| 1 | IT | 656 |
| 2 | サービス業 | 545 |
| 3 | 情報 | 287 |
| 4 | 通信業 | 277 |
| 5 | ITサービス | 152 |
| 6 | コンサル | 134 |
| 7 | サービス | 130 |
| 8 | 美容 | 129 |
| 9 | 健康 | 127 |
| 10 | 不動産 | 112 |

> ※ 区切り分割ロジック: `re.split(r"(、|・|/|／|,)")` → トリム → 空文字除外。

## 課題
1. 候補リストが 11 件のみで、CSV インポート結果と乖離している。
2. 完全一致フィルタのため複合表記がヒットしない。
3. 候補のメンテナンス方法が決まっていない。

## 改善方針

### フロントエンド
1. 業界フィルター UI を「入力付きコンボボックス」に変更。
   - 参考: shadcn/ui の `Command` + `Popover`、または `Combobox` パターン。
   - 既存の `Badge` 表示・削除は流用。
2. 候補リストは「頻出上位語（50〜100件）」をローカルに保持。
   - ファイル例: `saleslist-front/constants/industry-options.ts`。
   - JSON 生成スクリプトを `scripts` に追加しておくと更新容易。
3. ユーザー入力は大文字小文字区別なくフィルタリング。
4. 候補にない文字列もそのまま追加できるようにし、バックエンドへの検索パラメータとして送信。

### バックエンド
1. `CompanyFilter.filter_industry` を部分一致 (`icontains`) で検索するよう改修。
   - 入力配列は `Q(industry__icontains=value)` の OR で結合。
   - 将来的に AND サポートが必要な場合はクエリパラメータで挙動を切り替え可能にする。
2. パフォーマンス配慮
   - `icontains` はフルスキャンになるが、`industry` カラムに部分一致用の trigram インデックス（PostgreSQL 想定）等を追加する選択肢を検討。
   - SQLite/開発環境ではそのまま運用。
3. API レスポンス
   - 現状通り `industry` 値は文字列を返す。フィルター UI 側で複合表示は行わない。

### データ更新
1. 頻出業界語リスト生成スクリプト
   - コマンド例: `python scripts/generate_industry_tokens.py`
   - 出力: `saleslist-front/constants/industry-options.json`（ファイル生成後 TypeScript へ import）
2. マスタ連携
   - 当面はマスタ更新不要。将来的にマスタを「カテゴリ」用途で残しつつ、タグ候補は CSV から抽出する運用にする。

## 影響範囲
- フロント: 企業一覧フィルター、検索 UI、一部型定義。
- バックエンド: 企業 API (`CompanyViewSet`)、FilterSet。
- 付随: 既存 E2E テスト（業界フィルターシナリオ）の修正が必要。

## ToDo
1. 上位語 50 件程度を `industry-options.ts` として定義。
2. フィルター UI をコンボボックスへ置き換え。
3. `filter_industry` を `icontains` ベースに改修し、テスト追加。
4. E2E / 単体テストの更新（部分一致動作確認）。
5. トークン生成スクリプトを追加し、README などに運用手順を記載。

## 未決事項
- 頻出語リストの更新頻度と担当。
- 部分一致の OR / AND 切り替えニーズ。
- クライアント案件側の業界フィルターへの横展開有無。

